<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Webmap 201</title>
        <link rel="stylesheet" href="src/leaflet.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link rel="stylesheet" href="plugins/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css">
        <link rel="stylesheet" href="plugins/Leaflet.EasyButton/easy-button.css">
        <link rel="stylesheet" href="plugins/Leafet.Sidebar/L.Control.Sidebar.css"> 
        <link rel="stylesheet" href="plugins/Leaflet.StyleEditor/css/Leaflet.StyleEditor.min.css">
        <link rel="stylesheet" href="src/css/fontawesome-all.min.css">
        <link rel="stylesheet" href="plugins/Leaflet.awesomemarker/leaflet.awesome-markers.css">
        <link rel="stylesheet" href="plugins/Leaflet.MapKeyIcons/MapkeyIcons.css">
        <link rel="stylesheet" href="plugins/Leaflet.MapKeyIcons/L.Icon.Mapkey.css">
        <link rel="stylesheet" href="plugins/MarkerCluster.css">
        <link rel="stylesheet" href="plugins/MarkerCluster.Default.css">
        
        <script src="src/leaflet-src.js"></script>
        <script src="src/jquery-3.3.1.js"></script>
        <script src="plugins/Leaflet.MousePosition/L.Control.MousePosition.js"></script>
        <script src="plugins/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
        <script src="plugins/Leaflet.EasyButton/easy-button.js"></script>
        <script src="plugins/Leafet.Sidebar/L.Control.Sidebar.js"></script>
        <script src="plugins/leaflet-providers.js"></script>
        <script src="plugins/Leaflet.StyleEditor/javascript/Leaflet.StyleEditor.min.js"></script>
        <script src="plugins/leaflet.ajax.min.js"></script>
        <script src="plugins/leaflet.sprite.js"></script>
        <script src="plugins/Leaflet.awesomemarker/leaflet.awesome-markers.min.js"></script>
        <script src="plugins/Leaflet.MapKeyIcons/L.Icon.Mapkey.js"></script>
        <script src="plugins/leaflet.markercluster.js"></script>

        <!--    ***************  Begin Leaflet.Draw-->
        <link rel="stylesheet" href="plugins/leaflet-draw/leaflet.draw.css"/>
        
        <script src="plugins/leaflet-draw/Leaflet.draw.js"></script>
        <script src="plugins/leaflet-draw/Leaflet.Draw.Event.js"></script>

        <script src="plugins/leaflet-draw/edit/handler/Edit.Poly.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/Edit.SimpleShape.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/Edit.Rectangle.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/Edit.Marker.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/Edit.CircleMarker.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/Edit.Circle.js"></script>

        <script src="plugins/leaflet-draw/draw/handler/Draw.Feature.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.Polyline.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.Polygon.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.SimpleShape.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.Rectangle.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.Circle.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.Marker.js"></script>
        <script src="plugins/leaflet-draw/draw/handler/Draw.CircleMarker.js"></script>

        <script src="plugins/leaflet-draw/ext/TouchEvents.js"></script>
        <script src="plugins/leaflet-draw/ext/LatLngUtil.js"></script>
        <script src="plugins/leaflet-draw/ext/GeometryUtil.js"></script>
        <script src="plugins/leaflet-draw/ext/LineUtil.Intersect.js"></script>
        <script src="plugins/leaflet-draw/ext/Polyline.Intersect.js"></script>
        <script src="plugins/leaflet-draw/ext/Polygon.Intersect.js"></script>

        <script src="plugins/leaflet-draw/Control.Draw.js"></script>
        <script src="plugins/leaflet-draw/Tooltip.js"></script>
        <script src="plugins/leaflet-draw/Toolbar.js"></script>

        <script src="plugins/leaflet-draw/draw/DrawToolbar.js"></script>
        <script src="plugins/leaflet-draw/edit/EditToolbar.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/EditToolbar.Edit.js"></script>
        <script src="plugins/leaflet-draw/edit/handler/EditToolbar.Delete.js"></script>
        
<!--    **************  End of Lealet Draw-->
        
        <style>
            #mapdiv {
                height:100vh;
            }
            .col-xs-12, .col-xs-6, .col-xs-4{
                padding:3px;
            }
            #divProject {
                background-color: beige;
            }
            .errorMsg {
                padding:0px;
                text-align: center;
                background-color: lightsalmon;
            }
            
        </style>
    </head>
    <body>
        <div id="side-bar" class="col-md-3">
            <button id="btnLocate" class="btn btn-primary btn-block">Locate Me</button><br>
            <div id="divProject" class="col-xs-12">
                <div id="divProjectLabel" class="text-center col-xs-12">
                    <h4>Linear Projects</h4>  
                </div>
                <div id = "divProjectError" class="errorMsg col-xs-12"></div>
                <div id='divFindProject' class="form-group">
                    <div class="col-xs-6">
                        <input type="text" id="txtFindProject" class="form-control" placeholder="Project ID">
                    </div>
                    <div class="col-xs-6">
                        <btn id='btnFindProject' class="btn btn-primary btn-block">Find Project</btn>
                    </div>
                </div> 
                <div id="divProjectData" class=""></div>   
            </div>
        </div>
            
        <div id="mapdiv" class="col-md-12"></div>
        <script>
            var mymap;
            var lyrOSM;
            var lyrTopo;
            var lyrImagery;
            var lyrOutdoors;
            var lyrWatercolour;
            var lyrEagleNest;
            var lyrRaptorNest;
            var lyrMarkerCluster;
            var lyrClientLines;
            var lyrBUOWL;
            var lyrGBH;
            var lyrSearch;
            var mrkCurrentLocation;
            var fgpDrawnItems;
            var ctlMeasure;
            var ctlEasyButton;
            var ctlSidebar;
            var ctlLayers;
            var ctlDraw;
            var objBasemaps;
            var objOverlays;

			
            $(document).ready(function(){
                // ***************Map Initilisation ************
                mymap = L.map('mapdiv', {center:[40.18, -104.83], zoom:11, attributionControl:false});
                                ctlAttribute = L.control.attribution({position:'bottomleft'}).addTo(mymap);
                ctlAttribute.addAttribution('OSM');
                
                ctlScale = L.control.scale({position:'bottomleft', maxWidth:200}).addTo(mymap);
                ctlMousePosition = L.control.mousePosition().addTo(mymap);
                ctlMeasure = L.control.polylineMeasure().addTo(mymap);
                ctlSidebar = L.control.sidebar('side-bar').addTo(mymap);               
                
                ctlEasyButton = L.easyButton({
                    states: [{
                        stateName: 'open-sidebar',
                        icon:'glyphicon-triangle-right',
                        title:'Open sidebar',
                        onClick:function(control) {
                            ctlSidebar.show();
                            control.state('close-sidebar');
                        }
                },{
                    stateName: 'close-sidebar',
                    title: 'Close sidebar',
                    icon: 'glyphicon-triangle-left',
                    onClick:function(control) {
                            ctlSidebar.hide();
                            control.state('open-sidebar');
                        }
                      }]
                    });
                ctlEasyButton.addTo(mymap);
                
                var ctlStyle = L.control.styleEditor({
                    position:"topright",
                    openOnLeafletDraw:true
                });
                mymap.addControl(ctlStyle);
                
                
                // ***********Layer initilisation ************
                lyrOSM = L.tileLayer.provider('OpenStreetMap.Mapnik');
                lyrTopo = L.tileLayer.provider('OpenTopoMap');
                lyrImagery = L.tileLayer.provider('Esri.WorldImagery');
                lyrOutdoors = L.tileLayer.provider('Thunderforest.Outdoors');
                lyrWatercolour = L.tileLayer.provider('Stamen.Watercolor');
                mymap.addLayer(lyrOSM);
			
                fgpDrawnItems = new L.featureGroup();
                fgpDrawnItems.addTo(mymap);
                
                lyrEagleNest = L.geoJSON.ajax('data/wildlife_eagle.geojson', {
                    pointToLayer:returnEagleMarker
                }).addTo(mymap);
                
                lyrMarkerCluster = L.markerClusterGroup();
                
                
                lyrRaptorNest = L.geoJSON.ajax('data/wildlife_raptor.geojson', {
                    pointToLayer:returnRaptorMarker});
                    lyrRaptorNest.on('data:loaded', function(){
                        lyrMarkerCluster.addLayer(lyrRaptorNest);
                        lyrMarkerCluster.addTo(mymap);
                    });
                lyrClientLines = L.geoJSON.ajax('data/client_lines.geojson',
                    {style:styleClientLinears, onEachFeature:processClientLinears}).addTo(mymap);
                
                lyrBUOWL= L.geoJSON.ajax('data/wildlife_buowl.geojson',{style:styleBUOWL, onEachFeature:processBUOWL, filter:filterBUOWL}).addTo(mymap);
                
                lyrGBH = L.geoJSON.ajax('data/wildlife_gbh.geojson', {style:{color:'fuchsia'}}).bindTooltip('GBH Nesting Area').addTo(mymap);
                // *********************** Setup layer control *********************
                objBasemaps = {
                    "Open Street Map":lyrOSM,
                    "Topo Map":lyrTopo,
                    "Imagery":lyrImagery,
                    "Outdoors":lyrOutdoors, 
                    "Watercolour":lyrWatercolour
                };
                
                objOverlays = {
                    "Client Lines": lyrClientLines,
                    "Burrowing Owl Habitat": lyrBUOWL,
                    "Drawn Items":fgpDrawnItems,
                    "Eagle Nest": lyrEagleNest,
                    "Raptor Nest": lyrMarkerCluster,
                    "GBH Rookaries": lyrGBH
                };
                
                ctlLayers = L.control.layers(objBasemaps, objOverlays).addTo(mymap);
                //****** Draw control ************
                ctlDraw = new L.Control.Draw({
                    draw:{
                        circle:false,
                        circlemarker:false, 
                        rectangle:false
                    },
                    edit:{
                        featureGroup:fgpDrawnItems
                    }
                });
                mymap.addControl(ctlDraw);

                mymap.on('draw:created', function(e){
                    console.log(e);
                    fgpDrawnItems.addLayer(e.layer);
                });
                
                // ************ Location events 
                mymap.on('locationfound', function(e) {
                    console.log(e);
                    if (mrkCurrentLocation) {
                        mrkCurrentLocation.remove();
                    }
                    mrkCurrentLocation = L.circle(e.latlng,{radius:e.accuracy/2}).addTo(mymap);
                    mymap.setView(e.latlng,14);
                });
                
                mymap.on('locationerror', function(e) {
                    console.log(e);
                    alert("Location was not found");
                })
            });
            
            // *********BUOWL Functions *************
            
            function styleBUOWL(json){
                var att = json.properties;
                switch (att.hist_occup){
                    case 'Yes':
                        return {color:'deeppink', fillColor:'yellow'};
                        break;
                    case 'Undetermined':
                        return {color:'yellow'}
                        break;
                    }
            }
            
            function filterBUOWL(json){
                var att =json.properties;
                if (att.recentstatus=='REMOVED'){
                    return false;
                } else {
                    return true;
                }
            }
            
            function processBUOWL(json,lyr){
                var att= json.properties;
                lyr.bindTooltip("<h4>Habitat ID: "+att.habitat_id+"</h4>Historically Occupied:" +att.hist_occup+"<br>Status: "+att.recentstatus);
            }
            
            // **********jQuery event handlers *********
            $("#btnLocate").click(function(){
                    mymap.locate();
                });
            
            // ***********eagle functions *************
            
            function returnEagleMarker(json, latlng){
                var att = json.properties;
                if (att.status =='ACTIVE NEST') {
                    var clrNest = 'deeppink';
                }
                else {
                    var clrNest = 'darkgreen';
                }
                return L.circle(latlng, {radius:804, color:clrNest, fillColor: 'green', fillOpacity:0.5}).bindTooltip("<h4>Ealgle Nest : "+att.nest_id+"</h4>Status: "+att.status);
            }
            
            // ************** Raptor functions *****************
            function returnRaptorMarker (json, latlng){
                var att = json.properties;
                switch (att.recentspecies){
                    case "Red-tail Hawk":
                        var radRaptor = 533;
                        break;
                    case "Swainsons Hawk":
                        var radRaptor = 400;
                        break;
                    default:
                        var radRaptor = 804;
                        break;
                }
                switch (att.recentstatus){
                    case 'ACTIVE NEST':
                        var optRaptor = {radius:radRaptor,color:'deeppink',fillColor:'blue', fillOpacity:0.5};
                        break;
                    case 'INACTIVE NEST':
                        var optRaptor = {radius:radRaptor, color:'blue',fillColor:'blue', fillOpacity:0.5};
                        break;
                    case 'FLEDGED NEST':
                        var optRaptor = {radius:radRaptor,color:'deeppink',fillColor:'blue', fillOpacity:0.5, dashArray:[2,8]};
                        break;
                }
                return L.circle(latlng, optRaptor).bindPopup("<h4>Raptor Nest :"+att.Nest_ID+"</h4>Status: "+att.recentstatus+"<br>Species:"+att.recentspecies+"<br>Last Survey:"+att.lastsurvey);
            }
            
            // *************** Client linears ***********
            function styleClientLinears(json) {
                var att = json.properties;
                switch (att.type) {
                    case 'Pipeline':
                        return {color:'peru'};
                        break;
                    case 'Flowline':
                        return {color:'navy'};
                        break;
                    case 'Flowline, est.':
                        return {color:'navy', dashArray:"5,5"};
                        break;    
                    case 'Electric Line':
                        return {color:'darkgreen'};
                        break;
                    case 'Access Road - Confirmed':
                        return {color:'darkred'};
                        break;
                    case 'Access Road - Estimated':
                        return {color:'darkred', dashArray:"5,5"};
                        break;
                    case 'Extraction':
                        return {color:'indigo'};
                        break;
                    default:
                        return {color:'darkgoldenrod'};
                }
            }
            
            function processClientLinears(json,lyr){
                var att = json.properties;
                lyr.bindTooltip("<h4>Linear Project: "+att.Project+"</h4>Type: "+att.type+"<br>Row Width: "+att.row_width);
            }
            
            function returnClientLineByID(id){
                var arLayers = lyrClientLines.getLayers();
                for (i=0;i<arLayers.length-1;i++){
                    var featureID = arLayers[i].feature.properties.Project;
                    if (featureID == id) {
                        return arLayers[i];
                    }
                } 
                return false;
            }
            
            $('#btnFindProject').click(function(){
                var id = $("#txtFindProject").val();
                var lyr = returnClientLineByID(id);
                    if (lyr){
                        if (lyrSearch) {
                            lyrSearch.remove();
                        }
                        lyrSearch = L.geoJSON(lyr.toGeoJSON(), {style:{color:'red', weight:10, opacity:0.5}}).addTo(mymap);
                        mymap.fitBounds(lyr.getBounds().pad(1));
                        var att = lyr.feature.properties;
                        $("#divProjectData").html("<h4 class = 'text-center'>Attributes</h4><h5>Type :" +att.type+"</h5><h5> Row width: "+ att.row_width +"m </h5>");
                    } else {
                        $('#divProjectError').html("*******Project ID not found*****");
                    }
            });
            
            
            
        </script>
    </body>
</html>